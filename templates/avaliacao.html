{% extends "base.html" %}

{% block title %}eko - {{ album.nome or album.name }}{% endblock %}

{% block body_class %}class="body-avaliacao"{% endblock %}

{% block content %}
<style>
    /* --- CSS GLOBAL --- */
    .body-avaliacao { font-family: 'Prompt', sans-serif; background-color: #1F1F23; color: #EDEDED; }
    
    .container-avaliacao { 
        display: flex; 
        align-items: flex-start; 
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 40px 20px; 
        gap: 40px; /* Aumentei o espa√ßo entre colunas */
    }

    /* --- SIDEBAR (Esquerda) --- */
    .sidebar { width: 320px; flex-shrink: 0; position: sticky; top: 20px; }
    
    .album-cover img { 
        width: 100%; height: auto; display: block; 
        border-radius: 12px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
    }

    .sidebar-widget {
        background-color: #26262a;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
        border: 1px solid #333;
    }

    /* media geral */
    .user-rating { text-align: center; }
    .rating-number { 
        font-size: 32px; font-weight: bold; background-color: #FF6E1A; 
        color: #fff; display: inline-block; padding: 5px 15px; 
        border-radius: 8px; margin-bottom: 5px; 
        min-width: 80px;m√©dia geral
    }
    .rating-label { font-size: 14px; color: #ccc; font-weight: 600; letter-spacing: 1px; }
    .rating-meta { font-size: 12px; margin-top: 5px; color: #777; }

    /* --- MAIN CONTENT (Direita) --- */
    .main-content { 
        flex: 1; min-width: 0; 
    }
    
    /* Header do √Ålbum */
    .album-info { margin-bottom: 40px; border-bottom: 1px solid #333; padding-bottom: 20px; }
    .album-title { font-weight: 800; font-size: 48px; line-height: 1.1; margin-bottom: 10px; color: #fff; }
    .album-meta { display: flex; flex-wrap: wrap; gap: 15px; font-size: 16px; color: #aaa; align-items: center; }
    .artist { color: #fff; font-weight: bold; font-size: 20px; }

    .content-grid { display: grid; grid-template-columns: 1fr 1.2fr; gap: 50px; align-items: start; }

    /* Tracklist */
    .tracklist h2 { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #fff; letter-spacing: 1px; }
    .tracks { list-style: none; padding: 0; }
    .tracks li { 
        padding: 12px 0; border-bottom: 1px solid #2a2a2e; 
        display: flex; align-items: center; font-size: 14px; color: #ccc;
    }
    .tracks li:hover { color: #fff; }
    .track-num { color: #FF6E1A; font-weight: bold; margin-right: 15px; width: 25px; text-align: right; }
    .track-name { color: inherit; text-decoration: none; flex: 1; font-weight: 500; transition: 0.2s; }
    .track-name:hover { color: #FF6E1A; }

    .reviews h2 { font-size: 18px; margin-bottom: 20px; font-weight: bold; color: #fff; letter-spacing: 1px; }
    
    /* Formul√°rio */
    .review-form-box {
        background-color: #26262a; padding: 25px; border-radius: 12px; margin-bottom: 40px;
        border: 1px solid #333;
    }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #ccc; }
    .custom-input, .custom-textarea { 
        width: 100%; padding: 12px; background-color: #1a1a1d; 
        border: 1px solid #444; border-radius: 8px; color: #fff; 
        font-family: inherit; margin-bottom: 20px; font-size: 14px; 
    }
    .custom-input:focus, .custom-textarea:focus { outline: none; border-color: #FF6E1A; }
    
    .submit-btn { 
        background-color: #FF6E1A; color: #fff; font-weight: bold; 
        border: none; padding: 12px 20px; border-radius: 8px; 
        cursor: pointer; width: 100%; transition: 0.2s; font-size: 16px;
    }
    .submit-btn:hover { background-color: #ff8540; transform: translateY(-2px); }

    
    .slider-container { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
    .rating-display { font-size: 28px; font-weight: bold; color: #FF6E1A; min-width: 60px; text-align: right; }
    .slider { 
        -webkit-appearance: none; appearance: none; width: 100%; height: 8px; 
        border-radius: 5px; background: #444; outline: none; cursor: pointer; flex: 1;
    }
    .slider::-webkit-slider-thumb { 
        -webkit-appearance: none; appearance: none; width: 24px; height: 24px; 
        border-radius: 50%; background: #fff; cursor: pointer; 
        border: 4px solid #FF6E1A; margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

 
    .review-card { 
        background-color: #26262a; 
        padding: 20px; 
        border-radius: 12px; 
        margin-bottom: 20px; 
        position: relative; 
        border: 1px solid transparent;
        transition: 0.2s;
    }
    .review-card:hover { border-color: #444; }
    
    .review-header { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; }
    
    .review-author { font-weight: bold; color: #fff; font-size: 16px; }
    .review-date { font-size: 12px; color: #666; font-weight: normal; }
    
    .review-badge { 
        padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold;
    }
    
    .review-text { color: #ddd; font-size: 15px; line-height: 1.6; white-space: pre-wrap; }

    /* √çcone de Lixeira */
    .delete-icon {
        position: absolute;
        top: 20px; right: 20px;
        color: #555; font-size: 18px;
        text-decoration: none; transition: 0.2s;
        background: none; border: none; cursor: pointer;
    }
    .delete-icon:hover { color: #ff4444; transform: scale(1.1); }

    @media (max-width: 900px) {
        .container-avaliacao { flex-direction: column; gap: 30px; }
        .sidebar { width: 100%; max-width: 400px; margin: 0 auto; position: static; }
        .content-grid { grid-template-columns: 1fr; gap: 40px; }
        .album-title { font-size: 32px; }
    }
</style>

<div class="container-avaliacao"> 
    
    <aside class="sidebar">
        <div class="album-cover">
            {% if album.imagem %}
                <img src="{{ album.imagem }}" alt="{{ album.nome }}">
            {% elif album.images %}
                <img src="{{ album.images[0].url }}" alt="{{ album.name }}">
            {% else %}
                <div style="width: 100%; height: 320px; background: #333; border-radius: 12px;"></div>
            {% endif %}
        </div>

        <div style="margin-top: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); border-radius: 12px;">
            <iframe style="border-radius:12px" 
                    src="https://open.spotify.com/embed/album/{{ album.id or album.spotify_id }}?utm_source=generator&theme=0" 
                    width="100%" height="152" frameBorder="0" allowfullscreen="" 
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                    loading="lazy">
            </iframe>
        </div>

        <div class="sidebar-widget">
            <div class="user-rating">
                <div class="rating-number">
                    {% if reviews %}
                         {% set soma = namespace(val=0) %}
                         {% for r in reviews %}
                            {% set soma.val = soma.val + r.nota %}
                         {% endfor %}
                         {{ "%.1f"|format(soma.val / reviews|length) }}
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="rating-label">m√©dia geral</div>
                <div class="rating-meta">{{ reviews|length }} avalia√ß√µes da comunidade</div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        
        <section class="album-info">
            <h1 class="album-title">{{ album.nome or album.name }}</h1>
            <div class="album-meta">
                <span class="artist">
                    {% if album.artista %} {{ album.artista }} 
                    {% elif album.artists %} {{ album.artists[0].name }} 
                    {% endif %}
                </span>
                
                {% if album.data_lancamento %}
                    <span>‚Ä¢ {{ album.data_lancamento[:4] }}</span>
                {% elif album.release_date %}
                    <span>‚Ä¢ {{ album.release_date[:4] }}</span>
                {% endif %}
                
                {% if album.total_musicas %}
                     <span>‚Ä¢ {{ album.total_musicas }} faixas</span>
                {% elif album.total_tracks %}
                    <span>‚Ä¢ {{ album.total_tracks }} faixas</span>
                {% endif %}
            </div>
        </section>

        <div class="content-grid">
            
            <section class="tracklist">
                <h2>tracklist</h2>
                <ol class="tracks">
                    {% if tracks %}
                        {% for t in tracks %}
                            <li>
                                <span class="track-num">{{ loop.index }}</span>
                                <a href="{{ t.link_spotify or t.external_urls.spotify }}" target="_blank" class="track-name">
                                    {{ t.nome or t.name }}
                                </a>
                            </li>
                        {% endfor %}
                    {% else %}
                        <li style="color: #888;">Tracklist indispon√≠vel via busca.</li>
                    {% endif %}
                </ol>
            </section>

            <section class="reviews">
                
                <div class="review-form-box">
                    <h2>deixe sua avalia√ß√£o</h2>
                    <form id="formReview" action="{{ url_for('enviar_avaliacao', album_id=album.id or album.spotify_id) }}" method="POST">
                        
                        <div class="form-group">
                            <label>sua nota</label>
                            <div class="slider-container">
                                <input type="range" min="0" max="10" step="0.1" value="8.0" name="rating" class="slider" id="ratingRange">
                                <span id="ratingValue" class="rating-display">8.0</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>seu coment√°rio</label>
                            <textarea name="comentario" rows="3" class="custom-textarea" placeholder="O que voc√™ achou deste √°lbum? (Opcional)"></textarea>
                        </div>

                        <button type="submit" class="submit-btn">
                            publicar avalia√ß√£o
                        </button>
                    </form>
                </div>

                <div id="reviews">
                    <h3 style="font-size: 20px; margin-bottom: 20px; color: #fff; border-left: 4px solid #FF6E1A; padding-left: 10px;">
                        opini√µes da comunidade
                    </h3>
                    
{% if reviews %}
                        {% for review in reviews %}
                        <div class="review-card">
                            <div class="review-header">
                                <span class="review-author">{{ review.Usuario }}</span>
                                
                                {% if review.data %}
                                    <span class="review-date">‚Ä¢ {{ review.data.strftime('%d/%m/%Y') }}</span>
                                {% endif %}

                                <div style="flex:1;"></div>

                                {% set cor = '#4caf50' if review.nota >= 7 else '#ff9800' if review.nota >= 5 else '#f44336' %}
                                <span class="review-badge" style="background-color: {{ cor }}; color: white;">
                                    {{ review.nota }}
                                </span>
                            </div>

                            <div class="review-text">{{ review.comentario }}</div>

                            {% if session.get('usuario_email') == review.user_email %}
                                <div style="text-align: right; margin-top: 10px;">
                                    <a href="{{ url_for('deletar_avaliacao', review_id=review.id) }}" 
                                       style="color: #ff4444; font-size: 11px; text-decoration: none; border: 1px solid #ff4444; padding: 2px 8px; border-radius: 4px;"
                                       onclick="return confirm('Tem certeza que deseja excluir sua avalia√ß√£o?');">
                                       apagar avalia√ß√£o
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                        {% endfor %}    
                    {% else %}
                        <div style="text-align: center; padding: 40px; color: #666; border: 2px dashed #333; border-radius: 12px;">
                            <p style="margin-bottom: 10px; font-size: 18px;">ü§´</p>
                            <p>Ainda n√£o h√° avalia√ß√µes aqui.</p>
                            <p>Seja o primeiro a dar sua opini√£o!</p>
                        </div>
                    {% endif %}
                </div>
            </section>
        
        </div> 
    </main>
</div>

<script>
    const slider = document.getElementById("ratingRange");
    const output = document.getElementById("ratingValue");

    function updateSlider() {
        let val = parseFloat(slider.value).toFixed(1); 
        output.innerHTML = val;
        
        const percentage = (slider.value - slider.min) / (slider.max - slider.min) * 100;
        slider.style.background = `linear-gradient(to right, #FF6E1A ${percentage}%, #444 ${percentage}%)`;
    }

    slider.addEventListener("input", updateSlider);
    updateSlider(); 
</script>

{% endblock %}