{% extends "base.html" %}

{% block title %}eko - {{ album.nome }}{% endblock %}

{% block body_class %}class="body-avaliacao"{% endblock %}

{% block content %}
<style>
    /* CSS */
    .body-avaliacao { font-family: 'Prompt', sans-serif; background-color: #1F1F23; color: #EDEDED; }
    
    .container-avaliacao { 
        display: flex; 
        align-items: flex-start; 
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 40px 20px; 
        gap: 30px; 
    }

    .sidebar { width: 300px; flex-shrink: 0; position: sticky; top: 20px; }
    
    .album-cover img { 
        width: 100%; height: auto; display: block; margin-bottom: 20px; 
        border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
    }

    .rating-box { background-color: #2C2C30; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
    .user-rating, .your-rating { text-align: center; padding: 10px 0; }
    .your-rating { border-top: 1px solid #444; margin-top: 15px; padding-top: 15px; }
    
    .rating-number { 
        font-size: 28px; font-weight: bold; background-color: #FF6E1A; 
        color: #000; display: inline-block; padding: 2px 12px; 
        border-radius: 4px; margin-bottom: 5px; 
    }
    .rating-label { font-size: 14px; color: #ccc; }
    .rating-meta { font-size: 11px; margin-top: 5px; color: #888; }


    .main-content { 
        flex: 1; background-color: #2C2C30; padding: 40px; 
        border-radius: 12px; color: #EDEDED; min-width: 0; 
    }
    
    .album-info { margin-bottom: 30px; border-bottom: 1px solid #444; padding-bottom: 20px; }
    .album-title { font-weight: bold; font-size: 42px; line-height: 1.1; margin-bottom: 10px; color: #fff; }
    .album-meta { display: flex; flex-wrap: wrap; gap: 15px; font-size: 15px; color: #b0b0b0; }
    .artist { color: #fff; font-weight: bold; }


    .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; align-items: start; }

    /* Tracklist */
    .tracklist h2 { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #fff; }
    .tracks { list-style: none; padding: 0; }
    .tracks li { 
        padding: 10px 0; border-bottom: 1px solid #3a3a3e; 
        display: flex; align-items: center; font-size: 14px; 
    }
    .tracks li:hover { background-color: #353539; padding-left: 5px; border-radius: 4px; transition: 0.2s;}
    .track-num { color: #FF6E1A; font-weight: bold; margin-right: 15px; width: 20px; text-align: right; }
    .track-name { color: #EDEDED; text-decoration: none; flex: 1; }

    /* Reviews */
    .reviews h2 { font-size: 20px; margin-bottom: 20px; font-weight: bold; color: #fff; }
    
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #ccc; }
    .custom-input, .custom-textarea { 
        width: 100%; padding: 10px; background-color: #1F1F23; 
        border: 1px solid #444; border-radius: 6px; color: #fff; 
        font-family: inherit; margin-bottom: 15px; font-size: 14px; 
    }
    .custom-input:focus, .custom-textarea:focus { outline: none; border-color: #FF6E1A; }
    
    .submit-btn { 
        background-color: #FF6E1A; color: #000; font-weight: bold; 
        border: none; padding: 10px 20px; border-radius: 6px; 
        cursor: pointer; width: 100%; transition: 0.2s; 
    }
    .submit-btn:hover { background-color: #ff8540; }

    /* Slider */
    .slider-container { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .rating-display { font-size: 24px; font-weight: bold; color: #FF6E1A; min-width: 50px; }
    .slider { 
        -webkit-appearance: none; appearance: none; width: 100%; height: 6px; 
        border-radius: 5px; background: #444; outline: none; cursor: pointer; 
    }
    .slider::-webkit-slider-thumb { 
        -webkit-appearance: none; appearance: none; width: 18px; height: 18px; 
        border-radius: 50%; background: #EDEDED; cursor: pointer; 
        border: 2px solid #1F1F23; margin-top: -6px; 
    }

    /* Comentários */
    .review-item { border-bottom: 1px solid #444; padding: 15px 0; }
    .review-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .review-author { font-weight: bold; color: #FF6E1A; }
    .review-score { background: #444; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    .review-text { color: #ccc; font-size: 14px; line-height: 1.4; }

    @media (max-width: 900px) {
        .container-avaliacao { flex-direction: column; gap: 20px; }
        .sidebar { width: 100%; max-width: 350px; margin: 0 auto; position: static; }
        .content-grid { grid-template-columns: 1fr; gap: 30px; }
        .main-content { padding: 20px; }
    }
</style>

<div class="container-avaliacao"> 
    
    <aside class="sidebar">
        <div class="album-cover">
            {% if album.imagem %}
                <img src="{{ album.imagem }}" alt="{{ album.nome }}">
            {% elif album.images %}
                <img src="{{ album.images[0].url }}" alt="{{ album.name }}">
            {% else %}
                <div style="width: 100%; height: 300px; background: #333; border-radius: 8px;"></div>
            {% endif %}
        </div>

        <div class="rating-box">
            <div class="user-rating">
                <div class="rating-number">
                    {% if reviews %}
                         {% set soma = namespace(val=0) %}
                         {% for r in reviews %}
                            {% set soma.val = soma.val + r.nota %}
                         {% endfor %}
                         {{ "%.1f"|format(soma.val / reviews|length) }}
                    {% else %}
                        —
                    {% endif %}
                </div>
                <div class="rating-label">Média Geral</div>
                <div class="rating-meta">{{ reviews|length }} avaliações</div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        
        <section class="album-info">
            <h1 class="album-title">{{ album.nome or album.name }}</h1>
            <div class="album-meta">
                <span class="artist">
                    {% if album.artista %} {{ album.artista }} 
                    {% elif album.artists %} {{ album.artists[0].name }} 
                    {% endif %}
                </span>
                
                {% if album.data_lancamento %}
                    <span>• {{ album.data_lancamento[:4] }}</span>
                {% elif album.release_date %}
                    <span>• {{ album.release_date[:4] }}</span>
                {% endif %}
                
                {% if album.total_musicas %}
                     <span>• {{ album.total_musicas }} faixas</span>
                {% elif album.total_tracks %}
                    <span>• {{ album.total_tracks }} faixas</span>
                {% endif %}
            </div>
        </section>

        <div class="content-grid">
            
            <section class="tracklist">
                <h2>Tracklist</h2>
                <ol class="tracks">
                    {% if tracks %}
                        {% for t in tracks %}
                            <li>
                                <span class="track-num">{{ loop.index }}</span>
                                <a href="{{ t.link_spotify or t.external_urls.spotify }}" target="_blank" class="track-name">
                                    {{ t.nome or t.name }}
                                </a>
                                {% if t.preview_url %}
                                    <audio controls style="height: 20px; width: 80px; opacity: 0.7;">
                                        <source src="{{ t.preview_url }}" type="audio/mpeg">
                                    </audio>
                                {% endif %}
                            </li>
                        {% endfor %}
                    {% else %}
                        <li style="color: #888;">Tracklist indisponível via busca.</li>
                    {% endif %}
                </ol>
            </section>

            <section class="reviews">
                <h2>Deixe sua avaliação</h2>

                <form id="formReview" action="{{ url_for('enviar_avaliacao', album_id=album.id or album.spotify_id) }}" method="POST">
                    
                    <div class="form-group">
                        <label>Usuário Logado</label>
                        <input type="text" class="custom-input" value="{{ session['usuario_nome'] }}" readonly style="opacity: 0.7; cursor: not-allowed;">
                    </div>

                    <div class="form-group">
                        <label>Nota</label>
                        <div class="slider-container">
                            <input type="range" min="0" max="10" step="0.1" value="5.0" name="rating" class="slider" id="ratingRange">
                            <span id="ratingValue" class="rating-display">5.0</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Comentário</label>
                        <textarea name="comentario" rows="4" class="custom-textarea" placeholder="O que você achou deste álbum?" required></textarea>
                    </div>

                    <button type="submit" class="submit-btn">
                        Enviar Avaliação
                    </button>
                </form>

                <div id="reviews" style="margin-top: 40px;">
                    <h3 style="font-size: 18px; margin-bottom: 15px; color: #fff;">Comentários Recentes</h3>
                    
                    {% if reviews %}
                     {% for review in reviews %}
                            <div class="review-item">
                                <div class="review-header">
                      <span class="review-author">{{ review.Usuario }}</span>
                     <span class="review-score">Nota: {{ review.nota }}</span>
                </div>
             <div class="review-text">
             {{ review.comentario }}
             </div>
            </div>
        {% endfor %}    
                    {% else %}
                        <p style="color: #666; font-style: italic;">Seja o primeiro a avaliar!</p>
                    {% endif %}
                </div>
            </section>
        
        </div> 
    </main>
</div>

<script>
    const slider = document.getElementById("ratingRange");
    const output = document.getElementById("ratingValue");

    function updateSlider() {
        let val = parseFloat(slider.value).toFixed(1); 
        output.innerHTML = val;
        
        const percentage = (slider.value - slider.min) / (slider.max - slider.min) * 100;
        slider.style.background = `linear-gradient(to right, #FF6E1A ${percentage}%, #444 ${percentage}%)`;
    }

    slider.addEventListener("input", updateSlider);
    updateSlider(); 
</script>

{% endblock %}